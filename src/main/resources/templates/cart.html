<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Giỏ sách</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body class="bg-theme">
<div th:replace="fragments/header :: header"></div>
<div class="container mt-4">
    <h2 class="mb-3">Giỏ sách của bạn</h2>
    <div id="cart-items" class="list-group">
        <div class="list-group-item d-flex justify-content-between align-items-center"
             th:each="item, iterStat : ${session.cart}" th:data-index="${iterStat.index}">
            <div>
                <span>Tên sách<h5 th:text="${item.book.title}"></h5></span>
            </div>
            <div>
                <button class="btn btn-sm btn-success decrease ">-</button>
                <span class="quantity" th:text="${item.quantity}"></span>
                <button class="btn btn-sm btn-warning increase">+</button>
                <button class="btn btn-sm btn-danger remove">Xóa</button>
            </div>
        </div>
    </div>
    <div class="mt-3">
        <a th:href="@{/books}" class="btn btn-secondary">
            ← Quay lại danh sách
        </a>
        <button class="btn btn-primary" id="checkout">
            Xác nhận mượn:
            <span id="total-quantity" class=" fw-bold">0</span>
            cuốn
        </button>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const cartItems = document.querySelectorAll('#cart-items .list-group-item');

        const cartItemsContainer = document.getElementById('cart-items');
        const totalQuantityEl = document.getElementById('total-quantity');

        function updateTotalQuantity() {
            let total = 0;
            document.querySelectorAll('.quantity').forEach(qty => {
                total += parseInt(qty.textContent);
            });
            totalQuantityEl.textContent = total;
        }

        function updateBackendQuantity(bookId, quantity) {
            fetch('/cart/update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `bookId=${bookId}&quantity=${quantity}`
            });
        }

        function removeBackendQuantity(bookId) {
            fetch('/cart/remove', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `bookId=${bookId}`
            });
        }
        function borrowOrder() {
            fetch('/cart/checkout', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: ``
            });
        }

        updateTotalQuantity();

        cartItemsContainer.querySelectorAll('.list-group-item').forEach(item => {

            const quantityEl = item.querySelector('.quantity');
            const bookId = item.dataset.bookId;

            // tăng số lượng sách
            item.querySelector('.increase').addEventListener('click', () => {
                let q = parseInt(quantityEl.textContent) + 1;
                quantityEl.textContent = q;
                updateTotalQuantity();
                updateBackendQuantity(bookId, q);
            });

            // giảm số lượng sách
            item.querySelector('.decrease').addEventListener('click', () => {
                let q = parseInt(quantityEl.textContent);
                if (q > 1) {
                    q--;
                    quantityEl.textContent = q;
                    updateTotalQuantity();
                    updateBackendQuantity(bookId, q);
                }
            });

            //xoá sách
            item.querySelector('.remove').addEventListener('click', () => {
                item.remove();
                updateTotalQuantity();
                removeBackendQuantity(bookId);
            });
        });

        // xác nhận mượn
        document.getElementById('checkout').addEventListener('click', () => {
            alert('Đã xác nhận mượn ' + totalQuantityEl.textContent + ' cuốn sách!');
            borrowOrder();
            window.location.href = '/';
        });
    });
</script>
</body>
</html>