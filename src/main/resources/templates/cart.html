<!DOCTYPE html>
<!-- Khai báo tài liệu HTML5 -->
<html xmlns:th="http://www.thymeleaf.org">
<!-- Khai báo sử dụng Thymeleaf -->

<head>
    <meta charset="UTF-8">
    <!-- Thiết lập mã hóa UTF-8 -->

    <title>Giỏ sách</title>
    <!-- Tiêu đề trang giỏ sách -->

    <!-- Import Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Import CSS tùy chỉnh -->
    <link rel="stylesheet" href="/css/style.css">
</head>

<body class="bg-theme">
<!-- Áp dụng style nền cho toàn trang -->

<!-- Nhúng header dùng chung -->
<div th:replace="fragments/header :: header"></div>

<!-- Container nội dung chính -->
<div class="container mt-4">

    <!-- Tiêu đề trang -->
    <h2 class="mb-3">Giỏ sách</h2>

    <!-- Danh sách sách trong giỏ -->
    <div id="cart-items" class="list-group">

        <!-- Lặp qua danh sách cart lưu trong session -->
        <div class="list-group-item d-flex justify-content-between align-items-center"
             th:each="item, iterStat : ${session.cart}"
             th:data-index="${iterStat.index}"
             th:data-book-id="${item.book.id}">

            <!-- Thông tin sách -->
            <div>
                <span>Tên sách</span>
                <h5 th:text="${item.book.title}"></h5>
            </div>

            <!-- Các nút thao tác -->
            <div>
                <!-- Giảm số lượng -->
                <button class="btn btn-sm btn-success decrease">-</button>

                <!-- Hiển thị số lượng -->
                <span class="quantity" th:text="${item.quantity}"></span>

                <!-- Tăng số lượng -->
                <button class="btn btn-sm btn-warning increase">+</button>

                <!-- Xóa sách khỏi giỏ -->
                <button class="btn btn-sm btn-danger remove">Xóa</button>
            </div>
        </div>
    </div>

    <!-- Khu vực thao tác cuối -->
    <div class="mt-3">

        <!-- Quay lại trang danh sách sách -->
        <a th:href="@{/books}" class="btn btn-secondary">
            ← Quay lại danh sách sách
        </a>

        <!-- Nút xác nhận mượn -->
        <button class="btn btn-primary" id="checkout">
            Xác nhận mượn:
            <span id="total-quantity" class="fw-bold">0</span>
            cuốn
        </button>
    </div>
</div>

<script>
    // Chạy khi DOM đã load xong
    document.addEventListener('DOMContentLoaded', function () {

        const cartItemsContainer = document.getElementById('cart-items');
        const totalQuantityEl = document.getElementById('total-quantity');

        // Tính tổng số lượng sách trong giỏ
        function updateTotalQuantity() {
            let total = 0;
            document.querySelectorAll('.quantity').forEach(qty => {
                total += parseInt(qty.textContent);
            });
            totalQuantityEl.textContent = total;
        }

        // Gửi yêu cầu cập nhật số lượng về backend
        function updateBackend(bookId, quantity) {
            fetch('/cart/update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `bookId=${bookId}&quantity=${quantity}`
            });
        }

        // Gửi yêu cầu xóa sách khỏi giỏ
        function removeBackend(bookId) {
            fetch('/cart/remove', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `bookId=${bookId}`
            });
        }

        // Cập nhật tổng số lượng ban đầu
        updateTotalQuantity();

        // Gắn sự kiện cho từng item trong giỏ
        cartItemsContainer.querySelectorAll('.list-group-item').forEach(item => {

            const quantityEl = item.querySelector('.quantity');
            const bookId = item.dataset.bookId;

            // Tăng số lượng
            item.querySelector('.increase').addEventListener('click', () => {
                let q = parseInt(quantityEl.textContent) + 1;
                quantityEl.textContent = q;
                updateTotalQuantity();
                updateBackend(bookId, q);
            });

            // Giảm số lượng (không nhỏ hơn 1)
            item.querySelector('.decrease').addEventListener('click', () => {
                let q = parseInt(quantityEl.textContent);
                if (q > 1) {
                    q--;
                    quantityEl.textContent = q;
                    updateTotalQuantity();
                    updateBackend(bookId, q);
                }
            });

            // Xóa sách khỏi giỏ
            item.querySelector('.remove').addEventListener('click', () => {
                item.remove();
                updateTotalQuantity();
                removeBackend(bookId);
            });
        });

        // Xác nhận mượn sách
        document.getElementById('checkout').addEventListener('click', () => {
            alert('Đã xác nhận mượn ' + totalQuantityEl.textContent + ' cuốn sách!');
            window.location.href = '/';
        });
    });
</script>

</body>
</html>
